SB-Tree 源码说明（当前进度 & 下一步计划）
当前已完成（单线程 / 只追加阶段）

数据层

顺序插入（单调递增）→ 段转换为一串 DataBlock → 尾插到全局链表。

块内提供 N-ary 表 辅助查找与扫描（find / scan_from）。

搜索层（vector 版 B+ 风格）

叶层 L0：记录 {min_key, DataBlock\*}。

内层 L1/L2/…：新增条目凑满扇出 F 才做批量晋升；不足 F 的“尾巴”保留到下次（只追加，不分裂/合并）。

find_candidate(k) 自顶向下在已覆盖区间做 floor（返回“最后一个 min_key ≤ k 的叶块”）。

查询能力

点查 lookup(k)：用搜索层定位候选 → 块内查找 → 未命中沿 next 右移兜底（覆盖尾巴场景）。

顺序扫描 scan_from(start, count)：候选定位 → 块内扫 → 跨块续扫（不倒退起点）。

区间扫描 scan_range(l, r)：候选定位 → 块内二分裁剪到 [l, r] → 跨块直到越界停。

稳定性与测试

gtest 用例：晋升规则（凑满 F 才晋升）、端到端查找、尾巴未晋升、综合 E2E。

手写测试：顺序插入/验证、scan_from/scan_range 覆盖跨块与尾部。

Debug + ASan/LSan 排查修复过一次越界/悬挂引用问题；find_candidate 语义与尾巴场景对齐。

下一步建议路线图

A. 功能完善

区间扫描增强：提供回调/迭代器版本，避免一次性 materialize 大量结果。

分页接口：基于 scan_from 增加游标（“最后一个 key”）以支持翻页。

B. 延迟/乱序数据

设计 delta/缓冲区（如 per-thread buffer 或 append-only delta list），后台归并到数据层。

确定合并触发策略与与搜索层批量晋升的衔接。

C. 并发化

索引构建专线线程：前端写入只进队列；后台批量 append_run。

锁分层与读优化：数据层/索引层细粒度锁或读无锁；lookup 尽量走只读路径 + next 兜底。

D. 结构抽象与工程化

将 vector 版搜索层抽象为 SearchBlock，统一元数据（为持久化/并发做准备）。

内存管理：明确 DataBlock 所有权、回收策略、长尾块清理。

持久化 / 恢复：WAL + 快照；启动重建搜索层或加载索引元数据。

E. 性能与质量

参数调优：扇出 F、数据块大小、块内 N-ary 阶数。

基准与监控：构建吞吐/延迟、levels()/各层大小、晋升批次、lookup/scan QPS。

健壮性测试：随机多 run、边界键/洞洞键、Fuzz、压力与故障注入。

小优化（可选）：find_candidate 尾端向右窥视一步，在尾巴场景下更快命中目标块；不同层使用不同 F。

状态总结：
当前已完成顺序插入 → 搜索层只追加构建 → 点查/扫描的单线程闭环，核心测试通过。建议先补回调版扫描与简单并发索引构建，再逐步落地延迟数据与持久化。
